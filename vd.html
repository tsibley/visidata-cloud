<!doctype html>
<html>
<head>
  <title>VisiData Cloud</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="vendor/xterm.css">
  <style>
    body {
      display: flex;
      flex-direction: column;

      margin: 0;
      height: 100vh;
    }
    #terminal {
      flex: auto;
    }
  </style>
</head>
<body>
  <div id="terminal"></div>
  <script src="vendor/xterm.js"></script>
  <script src="vendor/xterm-addon-attach.js"></script>
  <script src="vendor/xterm-addon-fit.js"></script>
  <script>
    async function POST(url, options = {}) {
      const response = await fetch(url, {...options, method: "POST"});

      if (!response.ok) {
        const error = `POST ${url} failed`;
        console.error("%s: %o", error, response);
        throw error;
      }

      return response;
    }

    function queryString(kv = {}) {
      return (new URLSearchParams(kv)).toString();
    }

    class Container {
      constructor(id) {
        this.id = id;
      }

      static async create() {
        const createResponse = await POST("containers/create");
        const newContainer = await createResponse.json();

        console.info(`Created container «${newContainer.Id}»`);

        return new Container(newContainer.Id);
      }

      async start() {
        if (!this.id)
          throw "Container.start() called on object with no id";

        await POST(`containers/${this.id}/start`);
        console.info(`Started container «${this.id}»`);
      }

      async resizeTty(w, h) {
        if (!this.id)
          throw "Container.resizeTty() called on object with no id";

        await POST(`containers/${this.id}/resize?${queryString({w, h})}`);
        console.info(`Resized TTY to ${w}×${h} for container «${this.id}»`);
      }

      attachSocket() {
        // XXX TODO: Switch to wss
        // XXX TODO: Switch to our own endpoint
        return new WebSocket(`ws://localhost:8080/v1.40/containers/${this.id}/attach/ws?logs=1&stream=1&stdin=1&stdout=1&stderr=1`);
      }
    }

    try {
      launch();
    } catch (error) {
      console.error("Launch failure: %o", error);
    }

    async function launch() {
      const term = new Terminal();

      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);

      term.open(document.getElementById("terminal"));
      fitAddon.fit();

      // XXX TODO: add onresize listener to window to call fitAddon.fit(), debounced

      /****/

      const existingContainerId = (new URL(document.location)).searchParams.get("container");
      let container;

      // XXX TODO: Sanitize existingContainerId
      if (existingContainerId) {
        console.info(`Using existing container «${existingContainerId}»`);
        container = new Container(existingContainerId);
      } else {
        console.info("Launching new container…");
        container = await Container.create();
        container.start();
      }

      term.onResize(({cols, rows}) => container.resizeTty(cols, rows));
      container.resizeTty(term.cols, term.rows);

      console.info(`Attaching to container «${container.id}»…`);
      const attachAddon = new AttachAddon.AttachAddon(container.attachSocket());
      term.loadAddon(attachAddon);
    }
  </script>
</body>
</html>

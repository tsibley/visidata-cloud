<!doctype html>
<html>
<head>
  <title>VisiData Cloud</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="vendor/xterm.css">
  <style>
    body {
      display: flex;
      flex-direction: column;

      margin: 0;
      height: 100vh;
    }
    #terminal {
      flex: auto;
    }
  </style>
</head>
<body>
  <div id="terminal"></div>
  <script src="vendor/xterm.js"></script>
  <script src="vendor/xterm-addon-attach.js"></script>
  <script src="vendor/xterm-addon-fit.js"></script>
  <script>
    async function POST(url, options = {}) {
      const response = await fetch(url, {...options, method: "POST"});

      if (!response.ok) {
        const error = `POST ${url} failed`;
        console.error({msg: error, response});
        throw error;
      }

      return response;
    }

    function queryString(kv = {}) {
      return (new URLSearchParams(kv)).toString();
    }

    function debounce(delay, f) {
      let timeout;

      return function() {
        const f_ = () => f.apply(this, arguments);

        if (timeout)
          clearTimeout(timeout);

        timeout = setTimeout(f_, delay);
      };
    }

    class Container {
      constructor(id) {
        this.id = id;
      }

      static async create() {
        const createResponse = await POST("containers/create");
        const newContainer = await createResponse.json();

        console.info({msg: "created new container", container: newContainer.Id});

        return new Container(newContainer.Id);
      }

      async start() {
        if (!this.id)
          throw "Container.start() called on object with no id";

        await POST(`containers/${this.id}/start`);
        console.info({msg: "started container", container: this.id});
      }

      async resizeTty(w, h) {
        if (!this.id)
          throw "Container.resizeTty() called on object with no id";

        await POST(`containers/${this.id}/resize?${queryString({w, h})}`);
        console.info({msg: "resized tty", container: this.id, cols: w, rows: h});
      }

      attachSocket() {
        // XXX TODO: Switch to wss
        // XXX TODO: Switch to our own server endpoint
        // XXX TODO: Ensure the server does Origin checking and eventually authn/authz
        return new WebSocket(`ws://localhost:8080/v1.40/containers/${this.id}/attach/ws?logs=1&stream=1&stdin=1&stdout=1&stderr=1`);
      }
    }

    /****/

    launch()
      .catch(error => console.error({msg: "launch failure", error}));

    async function launch() {
      const term = new Terminal();

      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);

      term.open(document.getElementById("terminal"));
      fitAddon.fit();

      window.addEventListener("resize", debounce(200, () => fitAddon.fit()));

      /****/

      const existingContainerId = (new URL(document.location)).searchParams.get("container");

      if (existingContainerId && !existingContainerId.match(/^[a-zA-Z0-9_-]+$/))
        throw "container query parameter contains unpermitted characters";

      let container;

      if (existingContainerId) {
        console.info({msg: "using existing container", container: existingContainerId});
        container = new Container(existingContainerId);
      } else {
        console.info({msg: "launching new container"});
        container = await Container.create();
        await container.start();
      }

      history.replaceState(null, "", `?${queryString({container: container.id})}`);

      term.onResize(debounce(200, ({cols, rows}) => container.resizeTty(cols, rows)));
      container.resizeTty(term.cols, term.rows);

      console.info({msg: "attaching to container", container: container.id});
      const attachAddon = new AttachAddon.AttachAddon(container.attachSocket());
      term.loadAddon(attachAddon);
    }
  </script>
</body>
</html>
